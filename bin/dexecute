#! /usr/bin/env bash

set -o errexit

path="."
diffbranch="master"
suffixes=()
debugecho="${DEXECUTE_DEBUG}"

debug() {
  if [ -n "${debugecho}" ] ; then
    echo -e "\e[90m${@}\e[0m"
    echo
  fi
}

while test $# -gt 0 ; do
  case "$1" in
    "--diffbranch")
      shift
      diffbranch="$1"
      ;;
    "--suffix")
      shift
      suffixes+=("--regexp")
      suffixes+=("\\$1")
      ;;
    "--path")
      shift
      path="$1"
      ;;
    "--debug")
      debugecho="1"
      ;;
    "--")
      shift
      break
      ;;
    *)
      echo "Unrecognized option $1"
      exit 1
      ;;
  esac
  shift
done

debug "Filter: grep ${suffixes[@]}"

files=`git diff $diffbranch --diff-filter=d --relative --name-only $path | grep ${suffixes[@]} || [[ $? == 1 ]]`

if [ -z "$files" ] ; then
  echo "No changes detected"
else
  debug "${files}"
  debug "$@ {files}"
  echo $files | xargs $@
fi
